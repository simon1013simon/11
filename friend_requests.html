{% extends "base.html" %}
{% block content %}

<button class="btn btn-sm btn-outline-secondary mb-3"
        onclick="history.back()">
  â† è¿”å›
</button>

<h4 class="mb-3">ğŸ“© å¥½å‹é‚€è«‹</h4>

<ul id="request-list" class="list-group"></ul>

<script>
async function loadFriendRequests() {
  const res = await fetch('/friend_requests');
  const data = await res.json();
  const list = document.getElementById('request-list');
  list.innerHTML = '';

  if (data.length === 0) {
    list.innerHTML =
      '<li class="list-group-item text-muted">ç›®å‰æ²’æœ‰å¥½å‹é‚€è«‹</li>';
    return;
  }

  data.forEach(r => {
    const li = document.createElement('li');
    li.className =
      'list-group-item d-flex justify-content-between align-items-center';

    const passed = r.seconds_passed ?? 0;
    const remain = Math.max(0, 86400 - passed);
    const hours = Math.floor(remain / 3600);

    li.innerHTML = `
      <div>
        <div>${r.username}</div>
        <small class="text-muted">å‰©é¤˜ ${hours} å°æ™‚</small>
      </div>
      <div>
        <button class="btn btn-sm btn-success me-1">åŒæ„</button>
        <button class="btn btn-sm btn-outline-secondary">æ‹’çµ•</button>
      </div>
    `;

    const [okBtn, noBtn] = li.querySelectorAll('button');

    okBtn.onclick = async () => {
      okBtn.disabled = true;
      noBtn.disabled = true;

      await fetch('/accept_friend_request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ request_id: r.request_id })
      });

      loadFriendRequests();
      if (window.updateRequestBadge) updateRequestBadge();
    };

    noBtn.onclick = async () => {
      okBtn.disabled = true;
      noBtn.disabled = true;

      await fetch('/reject_friend_request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ request_id: r.request_id })
      });

      loadFriendRequests();
      if (window.updateRequestBadge) updateRequestBadge();
    };

    list.appendChild(li);
  });
}

/* åˆå§‹åŒ– */
loadFriendRequests();
if (window.updateRequestBadge) updateRequestBadge();
</script>

{% endblock %}
